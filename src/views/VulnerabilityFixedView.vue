<script setup lang="ts">
import { computed, onMounted, ref, watch } from 'vue'
import { useVulnerabilitiesFixed } from '@composables/useVulnerabilities'
import { VTable, VPopup, FixedVulnerability } from '@components'

const { data, total, loading, error, fetchVulnerabilitiesFixed } = useVulnerabilitiesFixed()
const ITEMS_PER_PAGE = 10

const TABLE_COLUMNS = [
    { header: 'CVE ID', key: 'cve_id', sortable: true, width: '150px' },
    { header: 'DESCRIPTION', key: 'description', sortable: false },
    { header: 'FIX', key: 'fixed' },
]
const pageSize = ref(10)
const currentPage = ref(1)

const pagination = computed(() => ({
    currentPage: 1,
    totalPages: Math.ceil((Number(total.value) || 0) / ITEMS_PER_PAGE),
}))

onMounted(async () => {
    await fetchVulnerabilitiesFixed()
    pagination.value.totalPages = Math.ceil(Number(total.value || 0) / pageSize.value)
})


const handlePageChange = (newPage: number) => {
    if (newPage > 0 && newPage <= pagination.value.totalPages) {
        currentPage.value = newPage
    }
}
const isPopupOpen = ref(false)
const selectedVulnerability = ref<any | null>(null)

const openPopup = (row: any) => {
    selectedVulnerability.value = row
    isPopupOpen.value = true
}


const closePopup = async () => {
    isPopupOpen.value = false
    await fetchVulnerabilitiesFixed() 
}

</script>

<template>
    <VTable
        :columns="TABLE_COLUMNS"
        :data="data ?? []"
        :pagination="pagination"
        @page-change="handlePageChange"
        :loading="loading"
        :error="error"
    >
        <template #fixed="{ row }">
            <button
                @click="openPopup(row)"
                class="py-1 px-2 text-xs p-0.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 cursor-pointer"
            >
                <span class="material-icons text-xs">build_circle</span>
            </button>
        </template>
    </VTable>
    <VPopup :isOpen="isPopupOpen" title="Fix vulnerability" @close="closePopup">
        <div v-if="selectedVulnerability">
            <FixedVulnerability :idVulnerability="selectedVulnerability.cve_id" :close="closePopup" />
        </div>
    </VPopup>
</template>
