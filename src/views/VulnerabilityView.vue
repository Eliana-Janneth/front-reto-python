<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { useVulnerabilities } from '@composables/useVulnerabilities'
import { VTable, VPopup, DetailVulnerability } from '@components'

const { data, total, loading, error, fetchVulnerabilities } = useVulnerabilities()

const columns = [
    { header: 'CVE ID', key: 'cve_id', sortable: true, width: '150px' },
    { header: 'DESCRIPTION', key: 'description', sortable: false },
    { header: 'STATE', key: 'fixed', sortable: false, width: '150px' },
    { header: 'DETAILS', key: 'details' },
]
const pageSize = ref(10)
const pagination = ref({
    currentPage: 1,
    totalPages: computed(() => Math.ceil((Number(total.value) || 0) / 10)),
})

onMounted(async () => {
    await fetchVulnerabilities()
    pagination.value.totalPages = Math.ceil(Number(total.value) / pageSize.value)
})

const handlePageChange = (newPage: number) => {
    if (newPage > 0 && newPage <= pagination.value.totalPages) {
        pagination.value.currentPage = newPage
    }
}

const isPopupOpen = ref(false)
const selectedVulnerability = ref<any | null>(null)

const openPopup = (row: any) => {
    selectedVulnerability.value = row
    isPopupOpen.value = true
}
</script>

<template>
    <VTable
        :columns="columns"
        :data="data ?? []"
        :pagination="pagination"
        @page-change="handlePageChange"
        :loading="loading"
        :error="error"
    >
        <template #fixed="{ row }">
            <p>{{ row.fixed ? 'Fixed' : 'Not Fixed' }}</p>
        </template>
        <template #details="{ row }">
            <button
                @click="openPopup(row)"
                class="py-1 px-2 text-xs p-0.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 cursor-pointer"
            >
                <span class="material-icons text-xs">visibility</span>
            </button>
        </template>
    </VTable>
    <VPopup :isOpen="isPopupOpen" title="Vulnerability Details" @close="isPopupOpen = false">
        <div v-if="selectedVulnerability">
            <DetailVulnerability :idVulnerability="selectedVulnerability.cve_id" />
        </div>
    </VPopup>
</template>
