<script setup lang="ts">
import { computed, onMounted, ref } from 'vue'
import { useVulnerabilitiesSummary } from '@composables/useVulnerabilities'
import { VCard, VPopup, VSpinner } from '@components'
import { formatDate } from '@/utils'

const { high, medium, low, loading, error, fetchVulnerabilitiesSummary } = useVulnerabilitiesSummary()

const ITEMS_PER_PAGE = 9
const activeTab = ref('HIGH')
const currentPage = ref(1)

const severityLevels = ref([
    { key: 'HIGH', label: 'High', total: computed(() => high.value?.total || 0) },
    { key: 'MEDIUM', label: 'Medium', total: computed(() => medium.value?.total || 0) },
    { key: 'LOW', label: 'Low', total: computed(() => low.value?.total || 0) },
])

onMounted(async () => {
    await fetchVulnerabilitiesSummary()
})

const vulnerabilities = computed(() => {
    let vulns = []
    switch (activeTab.value) {
        case 'HIGH':
            vulns = high.value?.vulnerabilities || []
            break
        case 'MEDIUM':
            vulns = medium.value?.vulnerabilities || []
            break
        case 'LOW':
            vulns = low.value?.vulnerabilities || []
            break
        default:
            vulns = []
    }
    const start = (currentPage.value - 1) * ITEMS_PER_PAGE
    const end = start + ITEMS_PER_PAGE
    return vulns.slice(start, end)
})

const totalPages = computed(() => {
    const level = severityLevels.value.find((lvl) => lvl.key === activeTab.value)
    return Math.ceil((level?.total || 0) / ITEMS_PER_PAGE)
})

const changePage = (page: number) => {
    if (page > 0 && page <= totalPages.value) {
        currentPage.value = page
    }
}

const isPopupOpen = ref(false)
const selectedVulnerability = ref<any | null>(null)

const openPopup = (vul: any) => {
    selectedVulnerability.value = vul
    isPopupOpen.value = true
}

const closePopup = () => {
    isPopupOpen.value = false
}
</script>

<template>
    <div
        class="text-sm font-medium text-center bg-gray-800 rounded-xl pb-3 px-2 text-purple-500 border-b border-purple-200 dark:text-purple-400 dark:border-purple-700"
    >
        <ul class="flex flex-wrap -mb-px">
            <li v-for="level in severityLevels" :key="level.key" class="me-2">
                <button
                    @click="
                        activeTab = level.key;
                        currentPage = 1
                    "
                    class="inline-block p-4 border-b-2 rounded-t-lg"
                    :class="{
                        'text-purple-600 border-purple-600 dark:text-purple-500 dark:border-purple-500':
                            activeTab === level.key,
                        'hover:text-purple-600 hover:border-purple-300 dark:hover:text-purple-300':
                            activeTab !== level.key,
                    }"
                >
                    {{ level.label }} ({{ level.total }})
                </button>
            </li>
        </ul>
    </div>
    <div v-if="loading" class="text-center mt-4"><VSpinner /></div>
    <div v-else-if="error" class="text-center mt-4 text-red-500">Error: {{ error }}</div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 py-10 gap-4">
        <VCard
            v-for="vul in vulnerabilities"
            :key="vul.id"
            :title="vul.vulnerability.cve_id"
            @click="openPopup(vul)"
            class="cursor-pointer group relative"
        >
            <p><strong>Access Vector:</strong> {{ vul.access_vector }}</p>
            <p><strong>Impact: </strong>{{ vul.impact }}</p>
            <p><strong>State:</strong> {{ vul.vulnerability.vuln_status }}</p>
            <p><strong>Published:</strong> {{ formatDate(vul.vulnerability.published) }}</p>
            <p><strong>Fixed:</strong> {{ vul.vulnerability.fixed ? 'Yes' : 'No' }}</p>
        </VCard>
    </div>

    <div v-if="!error || !loading" class="flex items-center justify-between px-4 py-3 bg-gray-800 rounded-xl">
        <button
            @click="changePage(currentPage - 1)"
            :disabled="currentPage === 1"
            class="px-4 py-2 text-white bg-purple-600 items-center flex gap-1 rounded hover:bg-purple-500 disabled:opacity-50"
        >
            <span class="material-icons" style="font-size: 14px"> arrow_back_ios </span>

            Back
        </button>
        <span class="font-bold text-sm text-purple-500"> Page {{ currentPage }} of {{ totalPages }} </span>
        <button
            @click="changePage(currentPage + 1)"
            :disabled="currentPage === totalPages"
            class="px-4 py-2 text-white bg-purple-600 items-center flex gap-1 rounded hover:bg-purple-500 disabled:opacity-50"
        >
            Next
            <span class="material-icons" style="font-size: 14px"> arrow_forward_ios </span>
        </button>
    </div>
</template>
